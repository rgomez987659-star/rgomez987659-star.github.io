<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>JustPersonal ¬∑ Panel Principal</title>
<style>
    :root {
        --bg: #f8fafc; --panel: #ffffff; --card: #ffffff; --muted: #64748b; --text: #0f172a;
        --line: #e2e8f0; --accent: #0ea5e9; --shadow: 0 4px 12px rgba(2,6,23,.08);
    }
    html[data-theme="dark"] {
        --bg: #0f172a; --panel: #1e293b; --card: #1e293b; --muted: #94a3b8; --text: #f1f5f9; --line: #334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%; scroll-behavior: smooth;}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:var(--text); transition: background .2s, color .2s;}
    h1,h2,h3{margin:0; line-height: 1.2;}
    header.top{padding:16px 24px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10; display:flex; justify-content:space-between; align-items:center;}
    main{max-width:1200px;margin:32px auto;padding:0 24px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow); transition: transform .2s, box-shadow .2s;}
    .card:hover{transform: translateY(-4px);}
    .card header{padding:20px 20px 0}
    .card .content{padding:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;}
    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:10px 14px;color:var(--text);cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;background:var(--panel);transition:.15s}
    .btn:hover{background:var(--bg); border-color: var(--accent);}
    .btn.primary{border-color:var(--accent);color:var(--accent); background: transparent;}
    .btn.primary:hover{background:var(--accent); color: white;}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--muted)}
    .btn.ghost:hover{color:var(--text); background: var(--bg);}
    .grid{display:grid;gap:16px}
    .grid.two{grid-template-columns:repeat(auto-fit,minmax(250px,1fr));}
    .grid.three{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
    .col{display: flex; flex-direction: column; gap: 4px;}
    label{font-size:13px;color:var(--muted); font-weight: 500;}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--bg);color:var(--text)}
    input:focus, select:focus, textarea:focus {outline: 2px solid var(--accent); border-color: transparent;}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line); border-radius: 12px; overflow: hidden;}
    th,td{padding:12px 16px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{background:var(--bg)}
    tr:last-child td {border-bottom: 0;}
    tr:nth-child(even) {background-color: var(--bg);}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom: 1px solid var(--line); margin-bottom: 24px;}
    .tab{padding:12px 16px;border-bottom: 2px solid transparent;background:transparent;color:var(--muted);cursor:pointer;user-select:none; font-weight: 600; margin-bottom: -1px;}
    .tab:hover{color: var(--text);}
    .tab[aria-selected="true"]{color:var(--accent); border-bottom-color: var(--accent);}
    .hidden{display:none !important}
    .dashboard-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px;}
    .section-launcher {display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 24px; cursor: pointer; gap: 12px;}
    .section-launcher span:first-child {font-size: 48px;}
    .section-launcher span:last-child {font-size: 18px; font-weight: 600;}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .kpi .box{background:var(--bg);border:1px solid var(--line);border-radius:12px;padding:16px; position: relative; padding-left: 60px;}
    .kpi .icon {position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 28px; }
    .kpi .title{font-size:14px;color:var(--muted)}
    .kpi .value{font-weight:700;font-size:24px;margin-top:4px}
    .section-panel{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%) scale(0.95); opacity: 0; width:90vw;height:90vh;max-width:1200px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;z-index:100;display:flex;flex-direction:column; pointer-events: none; transition: transform .3s, opacity .3s;}
    .section-panel.open{transform:translate(-50%, -50%) scale(1); opacity: 1; pointer-events: all;}
    .section-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--line);background:var(--bg)}
    .section-title{font-weight:700;font-size:18px}
    .section-body{flex:1;overflow:auto;padding:24px}
    .chat-launcher{position:fixed;right:24px;bottom:24px;z-index:70}
    .chat-bubble{position:fixed;right:24px;bottom:88px;width:380px;max-width:95vw;height:68vh;display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;z-index:70; transform: translateY(12px) scale(0.95); opacity: 0; transition: .3s; pointer-events: none;}
    .chat-bubble.open{transform: translateY(0) scale(1); opacity: 1; pointer-events: all;}
    .msg{max-width:84%;padding:10px 14px;border-radius:14px;border:1px solid var(--line);background:var(--panel); line-height: 1.5; word-wrap: break-word;}
    .msg.me{align-self:flex-end;background:#dbeafe; color: #1e40af;}
    html[data-theme="dark"] .msg.me{background: #3b82f6; color: white;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99;opacity:0; transition: opacity .3s; pointer-events: none;}
    .overlay.open{opacity:1; pointer-events: all;}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;z-index:110;opacity:0;transform:scale(0.95);transition:.3s;pointer-events:none;}
    .modal.open{opacity:1;transform:scale(1);pointer-events:all;}
    .modal .box{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow-lg);width:min(600px,95vw);max-height:80vh;display:flex;flex-direction:column;}
    .modal .box header{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:600;display:flex;justify-content:space-between;align-items:center;}
    .modal .box .content{padding:16px;overflow:auto;line-height:1.6;}
    .sync-status {position: fixed; top: 80px; right: 24px; padding: 8px 12px; border-radius: 8px; font-size: 12px; z-index: 50;}
    .sync-status.connected {background: #10b981; color: white;}
    .sync-status.disconnected {background: #ef4444; color: white;}
    .web-link {color: var(--accent); text-decoration: none; font-size: 12px;}
    .web-link:hover {text-decoration: underline;}
</style>
</head>
<body>
  <header class="top"><h1>JustPersonal ¬∑ Panel Principal</h1><div class="row"><button class="btn ghost" id="theme-toggle" title="Cambiar tema">üåô</button></div></header>
  <div class="sync-status" id="sync-status">üî¥ Desconectado</div>
  
  <main>
    <div class="dashboard-grid">
      <div class="card section-launcher" data-panel="panel-finanzas"><span>üí∞</span><span>Finanzas</span></div>
      <div class="card section-launcher" data-panel="panel-salud"><span>üè•</span><span>Salud</span></div>
      <div class="card section-launcher" data-panel="panel-entretenimiento"><span>üéÆ</span><span>Entretenimiento</span></div>
      <div class="card section-launcher" data-panel="panel-deportes"><span>‚öΩ</span><span>Deportes</span></div>
      <div class="card section-launcher" data-panel="panel-cocina"><span>üç≥</span><span>Cocina</span></div>
      <div class="card section-launcher" data-panel="panel-redes"><span>üì±</span><span>Redes Sociales</span></div>
    </div>
  </main>

  <div class="overlay" id="panel-overlay"></div>
  <div class="modal" id="modal"><div class="box"><header><span id="modal-title">Detalle</span><button class="btn ghost" id="modal-close">‚úñ</button></header><div class="content" id="modal-content"></div></div></div>
  
  <div class="section-panel" id="panel-finanzas"><div class="section-header"><div class="section-title">Finanzas</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body"><div class="tabs" role="tablist"><button aria-selected="true" class="tab" id="tab-resumen" role="tab">Resumen</button><button class="tab" id="tab-propiedades" role="tab">Propiedades</button><button class="tab" id="tab-alquileres" role="tab">Alquileres</button><button class="tab" id="tab-ingresos" role="tab">Ingresos</button><button class="tab" id="tab-gastos" role="tab">Gastos</button><button class="tab" id="tab-servicios" role="tab">Servicios</button></div><div id="panel-resumen" role="tabpanel"><div class="row" style="align-items:end;gap:16px; margin-bottom: 24px;"><input id="res-mes" type="month"/> <button class="btn" id="btn-refrescar-resumen">Refrescar</button> </div><h3 style="margin-bottom: 12px;">Resumen del Mes</h3><div class="kpi"><div class="box"><span class="icon">üì•</span><div class="title">Ingresos Mes</div><div class="value" id="kpi-ing-mes">$0</div></div><div class="box"><span class="icon">üè†</span><div class="title">Alquiler Mes</div><div class="value" id="kpi-renta-mes">$0</div></div><div class="box"><span class="icon">üì§</span><div class="title">Gastos Mes</div><div class="value" id="kpi-gas-mes">$0</div></div><div class="box"><span class="icon">üí∞</span><div class="title">Saldo Mes</div><div class="value" id="kpi-saldo-mes">$0</div></div></div><h3 style="margin: 24px 0 12px 0;">Acumulado Total</h3><div class="kpi"><div class="box"><span class="icon">üì•</span><div class="title">Ingresos Acum</div><div class="value" id="kpi-ing-acum">$0</div></div><div class="box"><span class="icon">üè†</span><div class="title">Alquiler Acum</div><div class="value" id="kpi-renta-acum">$0</div></div><div class="box"><span class="icon">üì§</span><div class="title">Gastos Acum</div><div class="value" id="kpi-gas-acum">$0</div></div><div class="box"><span class="icon">üí∞</span><div class="title">Saldo Acum</div><div class="value" id="kpi-saldo-acum">$0</div></div></div></div><div class="hidden" id="panel-propiedades" role="tabpanel"><div class="row" style="margin-bottom: 24px; justify-content: space-between;"><h2>Gesti√≥n de Propiedades</h2><button class="btn primary" id="btn-mostrar-formulario">‚ûï Agregar Propiedad</button></div><div class="card hidden" id="formulario-propiedad"><header><h2>A√±adir/Editar Propiedad</h2></header><div class="content"><form id="form-propiedad" class="grid two"><input id="prop-id" type="hidden"/><div class="col"><label for="prop-nombre">Nombre</label><input id="prop-nombre" required=""/></div><div class="col"><label for="prop-ciudad">Ciudad</label><input id="prop-ciudad" required=""/></div><div class="col"><label for="prop-direccion">Direcci√≥n</label><input id="prop-direccion"/></div><div class="col"><label for="prop-tipo">Tipo</label><select id="prop-tipo"><option value="Apartamento">Apartamento</option><option value="Apartaestudio">Apartaestudio</option><option value="Casa">Casa</option><option value="Local">Local</option></select></div><div class="col"><label for="prop-arrendatario">Arrendatario</label><input id="prop-arrendatario" required=""/></div><div class="col"><label for="prop-alquiler">Alquiler ($)</label><input id="prop-alquiler" type="number"/></div><div class="col"><label for="prop-empresa-energia">Empresa de Energ√≠a</label><input id="prop-empresa-energia"/></div><div class="col"><label for="prop-contrato-energia">Contrato Energ√≠a</label><input id="prop-contrato-energia"/></div><div class="col"><label for="prop-web-energia">P√°gina Web Energ√≠a</label><input id="prop-web-energia" type="url"/></div><div class="row" style="grid-column: 1 / -1;"><button class="btn primary" type="submit">Guardar</button><button class="btn ghost" id="btn-cancelar-propiedad" type="button">Cancelar</button></div></form></div></div><div class="card"><header><h2>Propiedades Guardadas</h2></header><div class="content"><table id="tabla-propiedades"><thead><tr><th>Propiedad</th><th>Ciudad</th><th>Tipo</th><th>Arrendatario</th><th>Alquiler</th><th>Energ√≠a</th><th>Acciones</th></tr></thead><tbody></tbody></table></div></div><div class="row" style="margin-top: 16px;"><button class="btn ghost" id="btn-cargar-ejemplo">Cargar Propiedades Ejemplo</button></div></div><div class="hidden" id="panel-alquileres" role="tabpanel"><div class="card"><header><h2>Registrar Pago de Alquiler</h2></header><div class="content"><form id="form-alquiler" class="grid three"><div class="col"><label for="alq-propiedad">Propiedad</label><select id="alq-propiedad" required></select></div><div class="col"><label for="alq-mes">Mes</label><input id="alq-mes" type="month" required/></div><div class="col"><label for="alq-monto">Monto Pagado</label><input id="alq-monto" type="number" required/></div><div class="row"><label style="display:flex; align-items:center; gap: 8px; margin-top: 1rem;"><input id="alq-pagado" type="checkbox"/>Pagado</label><button class="btn primary" type="submit">Guardar</button></div></form></div></div><div class="card" style="margin-top:24px;"><header><h2>Historial de Pagos de Alquiler</h2></header><div class="content"><table id="tabla-alquileres"><thead><tr><th>Propiedad</th><th>Mes</th><th>Monto</th><th>Estado</th><th></th></tr></thead><tbody></tbody></table></div></div></div><div class="hidden" id="panel-ingresos" role="tabpanel"><div class="card"><header><h2>A√±adir Ingreso</h2></header><div class="content"><form id="form-ingreso" class="grid three"><div class="col"><label for="ing-desc">Descripci√≥n</label><input id="ing-desc" required/></div><div class="col"><label for="ing-monto">Monto</label><input id="ing-monto" type="number" required/></div><div class="col"><label for="ing-fecha">Fecha</label><input id="ing-fecha" type="date" required/></div><div class="row"><button class="btn primary" type="submit">Guardar</button></div></form></div></div><div class="card" style="margin-top:24px;"><header><h2>Historial de Ingresos</h2></header><div class="content"><table id="tabla-ingresos"><thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th></th></tr></thead><tbody></tbody></table></div></div></div><div class="hidden" id="panel-gastos" role="tabpanel"><div class="card"><header><h2>A√±adir Gasto</h2></header><div class="content"><form id="form-gasto" class="grid three"><div class="col"><label for="gas-desc">Descripci√≥n</label><input id="gas-desc" required/></div><div class="col"><label for="gas-monto">Monto</label><input id="gas-monto" type="number" required/></div><div class="col"><label for="gas-fecha">Fecha</label><input id="gas-fecha" type="date" required/></div><div class="row"><button class="btn primary" type="submit">Guardar</button></div></form></div></div><div class="card" style="margin-top:24px;"><header><h2>Historial de Gastos</h2></header><div class="content"><table id="tabla-gastos"><thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Monto</th><th></th></tr></thead><tbody></tbody></table></div></div></div><div class="hidden" id="panel-servicios" role="tabpanel"><div class="card"><header><h2>Registrar Pago de Servicio</h2></header><div class="content"><form id="form-servicio" class="grid three"><div class="col"><label for="serv-propiedad">Propiedad</label><select id="serv-propiedad" required></select></div><div class="col"><label for="serv-empresa">Empresa</label><input id="serv-empresa" required/></div><div class="col"><label for="serv-mes">Mes</label><input id="serv-mes" type="month" required/></div><div class="row"><label style="display:flex; align-items:center; gap: 8px; margin-top: 1rem;"><input id="serv-pagado" type="checkbox"/>Pagado</label><button class="btn primary" type="submit">Guardar</button></div></form></div></div><div class="card" style="margin-top:24px;"><header><h2>Historial de Servicios</h2></header><div class="content"><table id="tabla-servicios"><thead><tr><th>Propiedad</th><th>Empresa</th><th>Mes</th><th>Estado</th><th></th></tr></thead><tbody></tbody></table></div></div></div></div></div>
  <div class="section-panel" id="panel-salud"><div class="section-header"><div class="section-title">Salud</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body"></div></div>
  <div class="section-panel" id="panel-entretenimiento"><div class="section-header"><div class="section-title">Entretenimiento</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body"></div></div>
  <div class="section-panel" id="panel-deportes"><div class="section-header"><div class="section-title">Deportes</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body"></div></div>
  <div class="section-panel" id="panel-cocina"><div class="section-header"><div class="section-title">Cocina</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body"></div></div>
  <div class="section-panel" id="panel-redes"><div class="section-header"><div class="section-title">Redes Sociales</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body"></div></div>

  <div class="chat-launcher"><button class="btn primary" id="open-chat" title="Asistente">üí¨</button></div>
  <aside class="chat-bubble" id="chat-panel"><div class="chat-header"><div class="chat-title">Asistente</div><div class="chat-actions"><button class="btn ghost" id="btn-clear-chat">üóëÔ∏è</button><button class="btn ghost" id="btn-close-chat">‚úñ</button></div></div><div class="chat-body" id="chat-body"></div><div class="chat-footer"><input id="chat-input" placeholder="Pregunta algo..."/><button class="btn primary" id="chat-send">Enviar</button></div></aside>
  <div class="toast" id="toast"></div>

  <script type="module">
    // ===== CONFIGURACI√ìN E IMPORTACI√ìN DE FIREBASE =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9vOVrtGrdVYU9FgUCtpZWOTwpmO5t2n4",
      authDomain: "propiedades-7f7fe.firebaseapp.com",
      projectId: "propiedades-7f7fe",
      storageBucket: "propiedades-7f7fe.appspot.com",
      messagingSenderId: "429219311761",
      appId: "1:429219311761:web:4d45c7c5e53cc7c5394f30"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    let userDocRef;

    // ===== ESTADO GLOBAL =====
    let state = {
        propiedades: [], chat: [], alquileres: [], ingresos: [], gastos: [], servicios: []
    };
    
    // ===== FUNCIONES DE UTILIDAD =====
    const $=(s,r=document)=>r.querySelector(s); 
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const toast=(m)=>{const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000)};
    const fmt=(n)=> new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(Number(n||0));
    const toYM=d=>(d||'').slice(0,7); 

    // ===== USUARIO FIJO PARA SINCRONIZACI√ìN =====
    const FIXED_USER_ID = "justpersonal_user_001";

    // ===== L√ìGICA DE DATOS (FIREBASE) - MEJORADA =====
    let persistTimeout = null;
    async function persist() {
        if (!userDocRef) {
            console.log("No hay referencia de usuario, no se puede guardar");
            return;
        }
        
        // Cancelar timeout anterior si existe
        if (persistTimeout) {
            clearTimeout(persistTimeout);
        }
        
        // Usar timeout para evitar m√∫ltiples escrituras r√°pidas
        persistTimeout = setTimeout(async () => {
            try { 
                console.log("Guardando en Firebase...", state);
                await setDoc(userDocRef, state); 
                console.log("Datos guardados correctamente en Firebase");
                updateSyncStatus('connected', 'üü¢ Sincronizado');
            } catch (e) { 
                console.error("Error al guardar en Firebase:", e); 
                toast('Error al guardar los datos');
                updateSyncStatus('error', 'üî¥ Error de sincronizaci√≥n');
            }
        }, 500); // Debounce de 500ms
    }

    function updateSyncStatus(status, message) {
        const statusEl = $('#sync-status');
        statusEl.textContent = message;
        statusEl.className = 'sync-status';
        if (status === 'connected') {
            statusEl.classList.add('connected');
        } else if (status === 'error') {
            statusEl.classList.add('disconnected');
        }
    }

    // ===== DATOS DE EJEMPLO =====
    const propiedadesEjemplo = [
        { id: '1', nombre: 'Apto VD Tulia', ciudad: 'Popay√°n', direccion: 'Clle 26 BN 4 a 16', tipo: 'Apartamento', arrendatario: '', alquiler: 780000, empresaEnergia: 'CEO', contratoEnergia: '', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '2', nombre: 'Apto 26 EN', ciudad: 'Popay√°n', direccion: 'Clle 26 EN 4 49', tipo: 'Apartamento', arrendatario: '', alquiler: 950000, empresaEnergia: 'CEO', contratoEnergia: '301656', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '3', nombre: 'Apto 26 EN', ciudad: 'Popay√°n', direccion: 'Clle 26 EN 4 50', tipo: 'Apartamento', arrendatario: '', alquiler: 850000, empresaEnergia: 'CEO', contratoEnergia: '301656', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '4', nombre: 'Apto 26 EN', ciudad: 'Popay√°n', direccion: 'Clle 26 EN 4 51', tipo: 'Apartaestudio', arrendatario: '', alquiler: 480000, empresaEnergia: 'CEO', contratoEnergia: '301656', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '5', nombre: 'Aptaestudio VD Tulia', ciudad: 'Popay√°n', direccion: 'Clle 26 BN 4 a 16', tipo: 'Apartaestudio', arrendatario: '', alquiler: 400000, empresaEnergia: 'CEO', contratoEnergia: '', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '6', nombre: 'Apto 1 BV sotano', ciudad: 'Popay√°n', direccion: 'Cll 62 N 10 -23', tipo: 'Apartamento', arrendatario: '', alquiler: 756000, empresaEnergia: 'CEO', contratoEnergia: '298401', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '7', nombre: 'Apto 2 BV 1 Piso', ciudad: 'Popay√°n', direccion: 'Cll 62 N 10 -23', tipo: 'Apartamento', arrendatario: '', alquiler: 850000, empresaEnergia: 'CEO', contratoEnergia: '298401', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '8', nombre: 'Apto 2 BV 2 piso', ciudad: 'Popay√°n', direccion: 'Cll 62 N 10 -23', tipo: 'Apartamento', arrendatario: '', alquiler: 800000, empresaEnergia: 'CEO', contratoEnergia: '298401', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '9', nombre: 'Apto 3 BV 3 Piso', ciudad: 'Popay√°n', direccion: 'Cll 62 N 10 -23', tipo: 'Apartamento', arrendatario: '', alquiler: 800000, empresaEnergia: 'CEO', contratoEnergia: '298401', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '10', nombre: 'Guayacanes', ciudad: 'Popay√°n', direccion: 'Calle 6 123 -80', tipo: 'Casa', arrendatario: '', alquiler: 1900000, empresaEnergia: 'CEO', contratoEnergia: '', webEnergia: 'https://www.ceoesp.com.co/paga-tu-facturaa' },
        { id: '11', nombre: 'San Vicente Panaderia', ciudad: 'Cali', direccion: 'Av 3 Norte 24 N 31', tipo: 'Local', arrendatario: '', alquiler: 911000, empresaEnergia: 'EMCALI', contratoEnergia: '', webEnergia: 'https://pagos.emcali.com.co/pagosweb/checkout' },
        { id: '12', nombre: 'San Vicente Alveco', ciudad: 'Cali', direccion: 'Av 3 Norte 24 N 31', tipo: 'Local', arrendatario: '', alquiler: 820000, empresaEnergia: 'EMCALI', contratoEnergia: '', webEnergia: 'https://pagos.emcali.com.co/pagosweb/checkout' },
        { id: '13', nombre: 'San Vicente MC', ciudad: 'Cali', direccion: 'Av 3 Norte 24 N 31', tipo: 'Local', arrendatario: '', alquiler: 970000, empresaEnergia: 'EMCALI', contratoEnergia: '', webEnergia: 'https://pagos.emcali.com.co/pagosweb/checkout' },
        { id: '14', nombre: 'San Vicente Piso 2 - 1', ciudad: 'Cali', direccion: 'Av 3 Norte 24 N 31', tipo: 'Apartaestudio', arrendatario: '', alquiler: 850000, empresaEnergia: 'EMCALI', contratoEnergia: '139833', webEnergia: 'https://pagos.emcali.com.co/pagosweb/checkout' },
        { id: '15', nombre: 'San Vicente Piso 2 - 2', ciudad: 'Cali', direccion: 'Av 3 Norte 24 N 31', tipo: 'Apartaestudio', arrendatario: '', alquiler: 850000, empresaEnergia: 'EMCALI', contratoEnergia: '139833', webEnergia: 'https://pagos.emcali.com.co/pagosweb/checkout' },
        { id: '16', nombre: 'San Vicente Piso 2 - 3', ciudad: 'Cali', direccion: 'Av 3 Norte 24 N 31', tipo: 'Apartaestudio', arrendatario: '', alquiler: 850000, empresaEnergia: 'EMCALI', contratoEnergia: '139833', webEnergia: 'https://pagos.emcali.com.co/pagosweb/checkout' }
    ];

    // ===== RENDERIZADO =====
    function renderAll() {
        renderPropiedades();
        renderAlquileres();
        renderIngresos();
        renderGastos();
        renderServicios();
        renderResumen();
        updatePropertyDropdowns();
    }
    
    function renderPropiedades(){ 
        const tb=$('#tabla-propiedades'); 
        if(!tb) return; 
        const tbody = tb.querySelector('tbody'); 
        tbody.innerHTML=''; 
        (state.propiedades || []).forEach((p,i)=>{ 
            const tr=document.createElement('tr'); 
            const webLink = p.webEnergia ? `<a href="${p.webEnergia}" target="_blank" class="web-link" title="Pagar energ√≠a">üîó Pagar</a>` : 'N/A';
            tr.innerHTML=`<td>${p.nombre}</td><td>${p.ciudad}</td><td>${p.tipo || 'N/A'}</td><td>${p.arrendatario || 'Sin arrendatario'}</td><td>${fmt(p.alquiler||0)}</td><td>${webLink}</td><td class="row"><button class="btn ghost" data-type="prop-edit" data-i="${i}">Editar</button><button class="btn ghost" data-type="prop-dup" data-i="${i}">Duplicar</button><button class="btn ghost" data-type="prop-del" data-i="${i}">Eliminar</button></td>`; 
            tbody.append(tr); 
        }); 
    }
    
    function renderAlquileres() { 
        const tbody = $('#tabla-alquileres tbody'); 
        if (!tbody) return; 
        tbody.innerHTML = ''; 
        (state.alquileres || []).forEach((a, i) => { 
            const prop = (state.propiedades || []).find(p => p.id === a.propId); 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `<td>${prop?.nombre || 'N/A'}</td><td>${a.mes}</td><td>${fmt(a.monto)}</td><td>${a.pagado ? '‚úÖ Pagado' : '‚ùå Pendiente'}</td><td><button class="btn ghost" data-type="alq-del" data-i="${i}">Eliminar</button></td>`; 
            tbody.append(tr); 
        }); 
    }
    
    function renderIngresos() { 
        const tbody = $('#tabla-ingresos tbody'); 
        if (!tbody) return; 
        tbody.innerHTML = ''; 
        (state.ingresos || []).forEach((ing, i) => { 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `<td>${ing.fecha}</td><td>${ing.desc}</td><td>${fmt(ing.monto)}</td><td><button class="btn ghost" data-type="ing-del" data-i="${i}">Eliminar</button></td>`; 
            tbody.append(tr); 
        }); 
    }
    
    function renderGastos() { 
        const tbody = $('#tabla-gastos tbody'); 
        if (!tbody) return; 
        tbody.innerHTML = ''; 
        (state.gastos || []).forEach((gas, i) => { 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `<td>${gas.fecha}</td><td>${gas.desc}</td><td>${fmt(gas.monto)}</td><td><button class="btn ghost" data-type="gas-del" data-i="${i}">Eliminar</button></td>`; 
            tbody.append(tr); 
        }); 
    }
    
    function renderServicios() { 
        const tbody = $('#tabla-servicios tbody'); 
        if (!tbody) return; 
        tbody.innerHTML = ''; 
        (state.servicios || []).forEach((s, i) => { 
            const prop = (state.propiedades || []).find(p => p.id === s.propId); 
            const tr = document.createElement('tr'); 
            tr.innerHTML = `<td>${prop?.nombre || 'N/A'}</td><td>${s.empresa}</td><td>${s.mes}</td><td>${s.pagado ? '‚úÖ Pagado' : '‚ùå Pendiente'}</td><td><button class="btn ghost" data-type="serv-del" data-i="${i}">Eliminar</button></td>`; 
            tbody.append(tr); 
        }); 
    }
    
    function renderResumen(){ 
        const ym=$('#res-mes')?.value||toYM(new Date().toISOString()); 
        if($('#res-mes')) $('#res-mes').value=ym; 
        const sum = (list, filter, key) => (list||[]).filter(filter).reduce((s, r) => s + Number(r[key] || 0), 0); 
        const ingM=sum(state.ingresos, r=>toYM(r.fecha)===ym, 'monto'), 
              gasM=sum(state.gastos, r=>toYM(r.fecha)===ym, 'monto'), 
              alqM=sum(state.alquileres, a=>a.mes===ym && a.pagado, 'monto'); 
        const ingA=sum(state.ingresos, ()=>true, 'monto'), 
              gasA=sum(state.gastos, ()=>true, 'monto'), 
              alqA=sum(state.alquileres, a => a.pagado, 'monto'); 
        const set=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=fmt(v);};
        set('kpi-ing-mes',ingM); 
        set('kpi-renta-mes',alqM); 
        set('kpi-gas-mes',gasM); 
        set('kpi-saldo-mes', (ingM+alqM)-gasM); 
        set('kpi-ing-acum',ingA); 
        set('kpi-renta-acum',alqA); 
        set('kpi-gas-acum',gasA); 
        set('kpi-saldo-acum', (ingA+alqA)-gasA); 
    }
    
    function updatePropertyDropdowns() { 
        $$('#alq-propiedad, #serv-propiedad').forEach(select => { 
            const currentVal = select.value; 
            select.innerHTML = '<option value="">Seleccionar Propiedad</option>'; 
            (state.propiedades || []).forEach(p => select.innerHTML += `<option value="${p.id}">${p.nombre}</option>`); 
            select.value = currentVal; 
        });
    }

    // ===== L√ìGICA DE UI Y EVENTOS =====
    let editingPropIndex = null;
    
    function startEditProp(index) {
        console.log("Editando propiedad en √≠ndice:", index);
        editingPropIndex = index;
        const p = state.propiedades[index];
        console.log("Propiedad a editar:", p);
        
        if (!p) {
            toast('Error: Propiedad no encontrada');
            return;
        }
        
        // Llenar el formulario con los datos de la propiedad
        $('#prop-id').value = p.id; 
        $('#prop-nombre').value = p.nombre || ''; 
        $('#prop-ciudad').value = p.ciudad || '';
        $('#prop-direccion').value = p.direccion || '';
        $('#prop-tipo').value = p.tipo || 'Apartamento';
        $('#prop-arrendatario').value = p.arrendatario || ''; 
        $('#prop-alquiler').value = p.alquiler || '';
        $('#prop-empresa-energia').value = p.empresaEnergia || '';
        $('#prop-contrato-energia').value = p.contratoEnergia || '';
        $('#prop-web-energia').value = p.webEnergia || '';
        
        // Mostrar el formulario
        mostrarFormulario();
        
        toast('Editando propiedad: ' + p.nombre);
    }

    function mostrarFormulario() {
        $('#formulario-propiedad').classList.remove('hidden');
        $('#formulario-propiedad').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function ocultarFormulario() {
        $('#formulario-propiedad').classList.add('hidden');
        editingPropIndex = null;
        $('#form-propiedad').reset();
        $('#prop-id').value = '';
    }

    // ===== ASISTENTE VIRTUAL MEJORADO =====
    const chat = { panel:$('#chat-panel'), body:$('#chat-body'), input:$('#chat-input') };
    
    async function pushMsg(html, me=false){ 
        const d=document.createElement('div'); 
        d.className='msg'+(me?' me':''); 
        d.innerHTML=html; 
        chat.body.append(d); 
        chat.body.scrollTop=chat.body.scrollHeight; 
        state.chat.push({me,html}); 
        await persist(); // Guardar autom√°ticamente despu√©s de cada mensaje
    }
    
    async function processAssistantQuery(query) {
        const q = query.toLowerCase().trim();
        let response = '';
        
        // Respuestas basadas en datos locales
        if (q.includes('cu√°ntas propiedades') || q.includes('cuantas propiedades')) {
            response = `Tienes ${state.propiedades.length} propiedades.`;
        } else if (q.includes('propiedades')) {
            if (state.propiedades.length === 0) {
                response = 'A√∫n no tienes propiedades registradas.';
            } else {
                response = `Tus propiedades son: <ul>` + state.propiedades.map(p => `<li>${p.nombre} - ${p.ciudad} (${fmt(p.alquiler)})</li>`).join('') + `</ul>`;
            }
        } else if (q.includes('resumen') || q.includes('finanzas')) {
            const ym = toYM(new Date().toISOString());
            const sum = (list, filter, key) => list.filter(filter).reduce((s, r) => s + Number(r[key] || 0), 0);
            const ingM = sum(state.ingresos, r => toYM(r.fecha) === ym, 'monto');
            const alqM = sum(state.alquileres, a => a.mes === ym && a.pagado, 'monto');
            const gasM = sum(state.gastos, r => toYM(r.fecha) === ym, 'monto');
            response = `üìä Resumen para ${ym}:<br>Ingresos: ${fmt(ingM + alqM)}<br>Gastos: ${fmt(gasM)}<br><b>Saldo: ${fmt((ingM + alqM) - gasM)}</b>`;
        } else if (q.includes('hola') || q.includes('buenos d√≠as') || q.includes('buenas tardes')) {
            response = '¬°Hola! üëã Soy tu asistente personal. Puedo ayudarte con informaci√≥n sobre tus propiedades, finanzas o buscar informaci√≥n en internet.';
        } else if (q.includes('gracias') || q.includes('thanks')) {
            response = '¬°De nada! üòä ¬øEn qu√© m√°s puedo ayudarte?';
        }
        
        if (response) { 
            await pushMsg(response); 
        } else { 
            // B√∫squeda en internet usando una API m√°s confiable
            await pushMsg(`üîç Buscando informaci√≥n sobre "${query}"...`);
            try {
                // Usamos Wikipedia API para obtener informaci√≥n m√°s confiable
                const wikiResponse = await fetch(`https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
                if (wikiResponse.ok) {
                    const data = await wikiResponse.json();
                    if (data.extract) {
                        response = `<strong>${data.title}:</strong><br>${data.extract}`;
                        if (data.thumbnail) {
                            response += `<br><img src="${data.thumbnail.source}" width="200" style="margin-top:10px; border-radius:8px;">`;
                        }
                    } else {
                        response = 'No encontr√© informaci√≥n espec√≠fica sobre tu consulta en Wikipedia.';
                    }
                } else {
                    // Fallback a DuckDuckGo si Wikipedia no funciona
                    const ddgResponse = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1`);
                    const ddgData = await ddgResponse.json();
                    if (ddgData.AbstractText) {
                        response = ddgData.AbstractText;
                    } else if (ddgData.RelatedTopics && ddgData.RelatedTopics.length > 0) {
                        response = ddgData.RelatedTopics[0].Text || 'Encontr√© informaci√≥n pero no puedo mostrarla aqu√≠.';
                    } else {
                        response = 'No encontr√© informaci√≥n espec√≠fica sobre tu consulta. ¬øPodr√≠as reformularla o ser m√°s espec√≠fico?';
                    }
                }
            } catch (e) {
                console.error("Error en b√∫squeda:", e);
                response = 'Lo siento, no pude acceder a internet en este momento. Intenta m√°s tarde.';
            }
            await pushMsg(response);
        }
    }

    // ===== INICIALIZACI√ìN MEJORADA =====
    document.addEventListener('DOMContentLoaded', async () => {
        console.log("Inicializando aplicaci√≥n...");
        
        // Configurar usuario fijo para sincronizaci√≥n
        try {
            console.log("Conectando con usuario fijo:", FIXED_USER_ID);
            
            // Usar un ID de usuario fijo para que todos los dispositivos compartan datos
            userDocRef = doc(db, "users", FIXED_USER_ID);
            
            updateSyncStatus('connecting', 'üü° Conectando...');
            
            // Escuchar cambios en tiempo real
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Datos cargados desde Firebase:", docSnap.data());
                    const firebaseData = docSnap.data();
                    
                    // Actualizar estado manteniendo la referencia
                    Object.keys(state).forEach(key => {
                        if (firebaseData[key] !== undefined) {
                            state[key] = firebaseData[key];
                        }
                    });
                    
                    renderAll();
                    
                    // Restaurar chat
                    chat.body.innerHTML = '';
                    (state.chat || []).forEach(msg => {
                        const d = document.createElement('div');
                        d.className = 'msg' + (msg.me ? ' me' : '');
                        d.innerHTML = msg.html;
                        chat.body.append(d);
                    });
                    chat.body.scrollTop = chat.body.scrollHeight;
                    
                    updateSyncStatus('connected', 'üü¢ Sincronizado');
                    toast('Datos cargados correctamente');
                } else {
                    console.log("No hay datos en Firebase, creando documento inicial...");
                    // Crear documento inicial si no existe
                    persist(); 
                    updateSyncStatus('connected', 'üü¢ Listo');
                }
            }, (error) => {
                console.error("Error en listener de Firebase:", error);
                updateSyncStatus('error', 'üî¥ Error de conexi√≥n');
                toast('Error de conexi√≥n con Firebase');
            });
            
        } catch (e) {
            console.error("Error de inicializaci√≥n:", e);
            toast('Error al inicializar la aplicaci√≥n');
        }

        // ===== EVENTOS DE INTERFAZ =====
        $('#theme-toggle').addEventListener('click', () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
            $('#theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        });

        // Panel de secciones
        $$('.section-launcher').forEach(el => {
            el.addEventListener('click', () => openSection(el.dataset.panel));
        });
        
        $$('.btn-close-section').forEach(el => {
            el.addEventListener('click', closeAllSections);
        });
        
        $('#panel-overlay').addEventListener('click', closeAllSections);

        // Tabs de finanzas
        window.selectFinanceTab = (tabId) => {
            $$('#panel-finanzas [role="tabpanel"]').forEach(p => p.classList.add('hidden'));
            $$('#panel-finanzas [role="tab"]').forEach(t => t.setAttribute('aria-selected', 'false'));
            $(`#panel-${tabId}`).classList.remove('hidden');
            $(`#tab-${tabId}`).setAttribute('aria-selected', 'true');
            
            // Ocultar formulario al cambiar de pesta√±a
            if (tabId !== 'propiedades') {
                ocultarFormulario();
            }
        };
        
        $$('#panel-finanzas [role="tab"]').forEach(tab => {
            tab.addEventListener('click', () => window.selectFinanceTab(tab.id.replace('tab-', '')));
        });

        // Bot√≥n para mostrar formulario
        $('#btn-mostrar-formulario').addEventListener('click', () => {
            mostrarFormulario();
        });

        // Bot√≥n para cancelar edici√≥n
        $('#btn-cancelar-propiedad').addEventListener('click', () => {
            ocultarFormulario();
            toast('Edici√≥n cancelada');
        });

        // Formulario de propiedades (CON PERSISTENCIA AUTOM√ÅTICA)
        $('#form-propiedad').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = $('#prop-id').value || Date.now().toString();
            const nombre = $('#prop-nombre').value.trim();
            const ciudad = $('#prop-ciudad').value.trim();
            const direccion = $('#prop-direccion').value.trim();
            const tipo = $('#prop-tipo').value;
            const arrendatario = $('#prop-arrendatario').value.trim();
            const alquiler = parseFloat($('#prop-alquiler').value) || 0;
            const empresaEnergia = $('#prop-empresa-energia').value.trim();
            const contratoEnergia = $('#prop-contrato-energia').value.trim();
            const webEnergia = $('#prop-web-energia').value.trim();

            if (!nombre || !ciudad || !arrendatario) {
                toast('Por favor completa todos los campos obligatorios');
                return;
            }

            const propiedad = { 
                id, 
                nombre, 
                ciudad, 
                direccion,
                tipo,
                arrendatario, 
                alquiler,
                empresaEnergia,
                contratoEnergia,
                webEnergia
            };
            
            if (editingPropIndex !== null) {
                // Editar propiedad existente
                console.log("Actualizando propiedad en √≠ndice:", editingPropIndex);
                state.propiedades[editingPropIndex] = propiedad;
                toast('Propiedad actualizada correctamente: ' + nombre);
                editingPropIndex = null;
            } else {
                // Agregar nueva propiedad
                state.propiedades.push(propiedad);
                toast('Propiedad guardada correctamente: ' + nombre);
            }
            
            await persist(); // Guardar autom√°ticamente en Firebase
            renderPropiedades();
            updatePropertyDropdowns();
            ocultarFormulario();
        });

        // Bot√≥n para cargar propiedades de ejemplo
        $('#btn-cargar-ejemplo').addEventListener('click', async () => {
            if (state.propiedades.length > 0 && !confirm('¬øEst√°s seguro de que quieres cargar las propiedades de ejemplo? Esto reemplazar√° las propiedades existentes.')) {
                return;
            }
            
            state.propiedades = [...propiedadesEjemplo];
            await persist();
            renderPropiedades();
            updatePropertyDropdowns();
            toast('Propiedades de ejemplo cargadas correctamente');
        });

        // Delegaci√≥n de eventos para acciones en tablas (CON PERSISTENCIA AUTOM√ÅTICA)
        document.addEventListener('click', async (e) => {
            const t = e.target;
            if (!t.dataset.type) return;
            
            const actionType = t.dataset.type;
            const index = parseInt(t.dataset.i);
            
            console.log("Acci√≥n detectada:", actionType, "en √≠ndice:", index);
            
            if (actionType === 'prop-edit') {
                startEditProp(index);
            } else if (actionType === 'prop-del') { 
                if (confirm('¬øEst√°s seguro de que quieres eliminar esta propiedad?')) {
                    state.propiedades.splice(index, 1); 
                    await persist(); // Guardar autom√°ticamente en Firebase
                    renderPropiedades(); 
                    updatePropertyDropdowns(); 
                    toast('Propiedad eliminada'); 
                }
            } else if (actionType === 'prop-dup') { 
                const p = state.propiedades[index]; 
                if (p) { 
                    state.propiedades.push({...p, id: Date.now().toString(), nombre: p.nombre + ' (copia)'}); 
                    await persist(); // Guardar autom√°ticamente en Firebase
                    renderPropiedades(); 
                    updatePropertyDropdowns(); 
                    toast('Propiedad duplicada'); 
                } 
            } else if (actionType === 'alq-del') { 
                state.alquileres.splice(index, 1); 
                await persist(); // Guardar autom√°ticamente en Firebase
                renderAlquileres(); 
                renderResumen(); 
                toast('Alquiler eliminado'); 
            } else if (actionType === 'ing-del') { 
                state.ingresos.splice(index, 1); 
                await persist(); // Guardar autom√°ticamente en Firebase
                renderIngresos(); 
                renderResumen(); 
                toast('Ingreso eliminado'); 
            } else if (actionType === 'gas-del') { 
                state.gastos.splice(index, 1); 
                await persist(); // Guardar autom√°ticamente en Firebase
                renderGastos(); 
                renderResumen(); 
                toast('Gasto eliminado'); 
            } else if (actionType === 'serv-del') { 
                state.servicios.splice(index, 1); 
                await persist(); // Guardar autom√°ticamente en Firebase
                renderServicios(); 
                toast('Servicio eliminado'); 
            }
        });

        // Formularios restantes (CON PERSISTENCIA AUTOM√ÅTICA)
        $('#form-alquiler').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const propId = $('#alq-propiedad').value;
            const mes = $('#alq-mes').value;
            const monto = parseFloat($('#alq-monto').value) || 0;
            const pagado = $('#alq-pagado').checked;
            
            if (!propId || !mes) {
                toast('Por favor completa todos los campos obligatorios');
                return;
            }
            
            state.alquileres.push({ propId, mes, monto, pagado });
            await persist(); // Guardar autom√°ticamente en Firebase
            renderAlquileres();
            renderResumen();
            form.reset();
            toast('Alquiler registrado');
        });

        $('#form-ingreso').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const desc = $('#ing-desc').value.trim();
            const monto = parseFloat($('#ing-monto').value) || 0;
            const fecha = $('#ing-fecha').value;
            
            if (!desc || !fecha) {
                toast('Por favor completa todos los campos obligatorios');
                return;
            }
            
            state.ingresos.push({ desc, monto, fecha });
            await persist(); // Guardar autom√°ticamente en Firebase
            renderIngresos();
            renderResumen();
            form.reset();
            toast('Ingreso registrado');
        });

        $('#form-gasto').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const desc = $('#gas-desc').value.trim();
            const monto = parseFloat($('#gas-monto').value) || 0;
            const fecha = $('#gas-fecha').value;
            
            if (!desc || !fecha) {
                toast('Por favor completa todos los campos obligatorios');
                return;
            }
            
            state.gastos.push({ desc, monto, fecha });
            await persist(); // Guardar autom√°ticamente en Firebase
            renderGastos();
            renderResumen();
            form.reset();
            toast('Gasto registrado');
        });

        $('#form-servicio').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const propId = $('#serv-propiedad').value;
            const empresa = $('#serv-empresa').value.trim();
            const mes = $('#serv-mes').value;
            const pagado = $('#serv-pagado').checked;
            
            if (!propId || !empresa || !mes) {
                toast('Por favor completa todos los campos obligatorios');
                return;
            }
            
            state.servicios.push({ propId, empresa, mes, pagado });
            await persist(); // Guardar autom√°ticamente en Firebase
            renderServicios();
            form.reset();
            toast('Servicio registrado');
        });

        // Chat
        $('#open-chat').addEventListener('click', () => {
            chat.panel.classList.toggle('open');
            chat.input.focus();
        });
        
        $('#btn-close-chat').addEventListener('click', () => {
            chat.panel.classList.remove('open');
        });
        
        $('#btn-clear-chat').addEventListener('click', async () => {
            chat.body.innerHTML = '';
            state.chat = [];
            await persist(); // Guardar autom√°ticamente en Firebase
            toast('Chat limpiado');
        });
        
        $('#chat-send').addEventListener('click', sendChatMessage);
        
        chat.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        async function sendChatMessage() {
            const msg = chat.input.value.trim();
            if (!msg) return;
            
            await pushMsg(msg, true);
            chat.input.value = '';
            await processAssistantQuery(msg);
        }

        // Refrescar resumen
        $('#btn-refrescar-resumen').addEventListener('click', renderResumen);
        $('#res-mes').addEventListener('change', renderResumen);
        
        // Inicializar fecha actual
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const today = `${year}-${month}`;
        $('#res-mes').value = today;
        
        // Inicializar tema
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        $('#theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        
        // Render inicial
        renderAll();
        console.log("Aplicaci√≥n inicializada correctamente");
    });

    // ===== FUNCIONES AUXILIARES DE UI =====
    function openSection(id) {
        closeAllSections();
        $(`#${id}`).classList.add('open');
        $('#panel-overlay').classList.add('open');
    }
    
    function closeAllSections() {
        $$('.section-panel').forEach(p => p.classList.remove('open'));
        $('#panel-overlay').classList.remove('open');
        editingPropIndex = null;
        $('#form-propiedad').reset();
        $('#prop-id').value = '';
        ocultarFormulario();
    }
  </script>
</body>
</html>