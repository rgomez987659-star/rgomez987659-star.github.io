<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>JustPersonal ¬∑ Registro</title>
<style>
    :root {
        --bg: #f8fafc; --panel: #ffffff; --card: #ffffff; --muted: #64748b; --text: #0f172a;
        --line: #e2e8f0; --accent: #0ea5e9; --shadow: 0 4px 12px rgba(2,6,23,.08);
    }
    html[data-theme="dark"] {
        --bg: #0f172a; --panel: #1e293b; --card: #1e293b; --muted: #94a3b8; --text: #f1f5f9; --line: #334155;
    }
    *{box-sizing:border-box; margin:0; padding:0;}
    body{background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text);}
    
    /* Estilos Login */
    .login-screen {position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:24px;padding:24px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow); max-width:400px;width:100%;}
    .card header{padding:24px 20px 0; text-align:center;}
    .card .content{padding:20px}
    .grid{display:grid;gap:16px}
    .col{display: flex; flex-direction: column; gap: 4px;}
    label{font-size:13px;color:var(--muted); font-weight: 500;}
    input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--bg);color:var(--text)}
    input:focus {outline: 2px solid var(--accent); border-color: transparent;}
    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:10px 14px;color:var(--text);cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;background:var(--panel);transition:.15s; width:100%; justify-content:center;}
    .btn.primary{border-color:var(--accent);color:var(--accent); background: transparent;}
    .btn.primary:hover{background:var(--accent); color: white;}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--muted); width:auto;}
    .btn.ghost:hover{color:var(--text); background: var(--bg);}
    .btn:disabled{opacity:0.6; cursor:not-allowed;}
    .hidden{display:none !important}
    .password-field {position: relative;}
    .password-toggle {position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--muted); cursor: pointer;}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#ef4444;color:white;padding:12px 20px;border-radius:8px;z-index:1001;}
    .toast.show{display:block;}
    .toast:not(.show){display:none;}
    .success{background:#10b981;}
    .login-tabs{display:flex;border-bottom:1px solid var(--line);margin-bottom:20px;}
    .login-tab{padding:12px 16px;border:none;background:none;color:var(--muted);cursor:pointer;flex:1;font-weight:600;}
    .login-tab.active{color:var(--accent);border-bottom:2px solid var(--accent);}
    
    /* Estilos App Principal */
    header.top{padding:16px 24px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10; display:flex; justify-content:space-between; align-items:center;}
    main{max-width:1200px;margin:32px auto;padding:0 24px;}
    .dashboard-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px;}
    .section-launcher {display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 24px; cursor: pointer; gap: 12px; background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow); transition: transform .2s, box-shadow .2s;}
    .section-launcher:hover{transform: translateY(-4px);}
    .section-launcher span:first-child {font-size: 48px;}
    .section-launcher span:last-child {font-size: 18px; font-weight: 600;}
    .user-info {display:flex;align-items:center;gap:8px;font-size:14px;}
</style>
</head>
<body>
  <!-- Pantalla de Login/Registro -->
  <div class="login-screen" id="login-screen">
    <div class="card">
      <header>
        <h1>JustPersonal</h1>
        <p style="color:var(--muted);margin:8px 0 0;">Gesti√≥n de Propiedades Inteligente</p>
      </header>
      <div class="content">
        <div class="login-tabs">
          <button type="button" class="login-tab active" id="tab-register">Registrarse</button>
          <button type="button" class="login-tab" id="tab-login">Iniciar Sesi√≥n</button>
        </div>
        
        <!-- Formulario de Registro -->
        <form id="register-form" class="grid">
          <div class="col">
            <label for="user-email">Correo Electr√≥nico</label>
            <input type="email" id="user-email" required placeholder="tu@email.com"/>
          </div>
          <div class="col">
            <label for="user-name">Nombre Completo</label>
            <input type="text" id="user-name" required placeholder="Tu nombre completo"/>
          </div>
          <div class="col password-field">
            <label for="user-password">Contrase√±a</label>
            <input type="password" id="user-password" required placeholder="M√≠nimo 6 caracteres" minlength="6"/>
            <button type="button" class="password-toggle" id="toggle-password">üëÅÔ∏è</button>
          </div>
          <div class="col">
            <button type="submit" class="btn primary" id="btn-register">
              <span id="btn-register-text">Crear Cuenta</span>
              <span id="btn-register-loading" class="hidden">‚è≥ Creando cuenta...</span>
            </button>
          </div>
        </form>

        <!-- Formulario de Login -->
        <form id="login-form" class="grid hidden">
          <div class="col">
            <label for="login-email">Correo Electr√≥nico</label>
            <input type="email" id="login-email" required placeholder="tu@email.com"/>
          </div>
          <div class="col password-field">
            <label for="login-password">Contrase√±a</label>
            <input type="password" id="login-password" required placeholder="Tu contrase√±a"/>
            <button type="button" class="password-toggle" id="toggle-login-password">üëÅÔ∏è</button>
          </div>
          <div class="col">
            <button type="submit" class="btn primary" id="btn-login">
              <span id="btn-login-text">Iniciar Sesi√≥n</span>
              <span id="btn-login-loading" class="hidden">‚è≥ Iniciando sesi√≥n...</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Aplicaci√≥n Principal -->
  <div id="app-main" class="hidden">
    <header class="top">
      <h1>JustPersonal ¬∑ Panel Principal</h1>
      <div class="row">
        <div class="user-info">
          <span id="user-display">Usuario</span>
          <button class="btn ghost" id="btn-logout" title="Cerrar sesi√≥n">üë§ Cerrar Sesi√≥n</button>
        </div>
        <button class="btn ghost" id="theme-toggle" title="Cambiar tema">üåô</button>
      </div>
    </header>
    
    <main>
      <div class="dashboard-grid">
        <div class="card section-launcher" data-panel="panel-finanzas">
          <span>üí∞</span>
          <span>Finanzas</span>
        </div>
        <div class="card section-launcher" data-panel="panel-salud">
          <span>üè•</span>
          <span>Salud</span>
        </div>
        <div class="card section-launcher" data-panel="panel-entretenimiento">
          <span>üéÆ</span>
          <span>Entretenimiento</span>
        </div>
        <div class="card section-launcher" data-panel="panel-deportes">
          <span>‚öΩ</span>
          <span>Deportes</span>
        </div>
        <div class="card section-launcher" data-panel="panel-cocina">
          <span>üç≥</span>
          <span>Cocina</span>
        </div>
        <div class="card section-launcher" data-panel="panel-redes">
          <span>üì±</span>
          <span>Redes Sociales</span>
        </div>
      </div>

      <!-- Secci√≥n de Propiedades (Ejemplo de contenido) -->
      <div style="margin-top: 40px;">
        <h2>Mis Propiedades</h2>
        <div class="card" style="margin-top: 16px;">
          <div class="content">
            <p>Aqu√≠ se mostrar√°n tus propiedades una vez que agregues alguna.</p>
            <button class="btn primary" style="margin-top: 12px; width: auto;">
              ‚ûï Agregar Primera Propiedad
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // ===== CONFIGURACI√ìN FIREBASE =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      setDoc 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9vOVrtGrdVYU9FgUCtpZWOTwpmO5t2n4",
      authDomain: "propiedades-7f7fe.firebaseapp.com",
      projectId: "propiedades-7f7fe",
      storageBucket: "propiedades-7f7fe.appspot.com",
      messagingSenderId: "429219311761",
      appId: "1:429219311761:web:4d45c7c5e53cc7c5394f30"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== FUNCIONES DE UTILIDAD =====
    const $ = (id) => document.getElementById(id);
    const showToast = (message, isSuccess = false) => {
      const toast = $('#toast');
      toast.textContent = message;
      toast.className = `toast show ${isSuccess ? 'success' : ''}`;
      setTimeout(() => toast.classList.remove('show'), 4000);
    };

    // ===== MANEJO DE AUTENTICACI√ìN =====
    function showLoginForm() {
      $('#register-form').classList.add('hidden');
      $('#login-form').classList.remove('hidden');
      $('#tab-register').classList.remove('active');
      $('#tab-login').classList.add('active');
    }

    function showRegisterForm() {
      $('#login-form').classList.add('hidden');
      $('#register-form').classList.remove('hidden');
      $('#tab-login').classList.remove('active');
      $('#tab-register').classList.add('active');
    }

    // ===== REGISTRO DE NUEVO USUARIO =====
    async function handleRegistration(e) {
      e.preventDefault();
      
      const email = $('#user-email').value.trim();
      const name = $('#user-name').value.trim();
      const password = $('#user-password').value;

      if (!email || !name || !password) {
        showToast('‚ùå Por favor completa todos los campos');
        return;
      }

      if (password.length < 6) {
        showToast('‚ùå La contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      setLoadingState('register', true);

      try {
        console.log('üîê Intentando crear usuario...');
        
        // 1. Crear usuario en Authentication
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log('‚úÖ Usuario creado:', user.uid);

        // 2. Actualizar perfil con nombre
        await updateProfile(user, {
          displayName: name
        });

        // 3. Guardar informaci√≥n adicional en Firestore
        try {
          await setDoc(doc(db, "users", user.uid), {
            email: email,
            name: name,
            createdAt: new Date().toISOString(),
            lastLogin: new Date().toISOString()
          });
        } catch (firestoreError) {
          console.warn('‚ö†Ô∏è Error guardando en Firestore:', firestoreError);
        }

        showToast('üéâ ¬°Cuenta creada exitosamente!', true);
        showMainApp(user);

      } catch (error) {
        console.error('‚ùå Error en registro:', error);
        handleAuthError(error);
      } finally {
        setLoadingState('register', false);
      }
    }

    // ===== LOGIN DE USUARIO EXISTENTE =====
    async function handleLogin(e) {
      e.preventDefault();
      
      const email = $('#login-email').value.trim();
      const password = $('#login-password').value;

      if (!email || !password) {
        showToast('‚ùå Por favor completa todos los campos');
        return;
      }

      setLoadingState('login', true);

      try {
        console.log('üîê Intentando iniciar sesi√≥n...');
        
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log('‚úÖ Sesi√≥n iniciada:', user.uid);
        
        // Actualizar √∫ltimo login en Firestore
        try {
          await setDoc(doc(db, "users", user.uid), {
            lastLogin: new Date().toISOString()
          }, { merge: true });
        } catch (firestoreError) {
          console.warn('‚ö†Ô∏è Error actualizando √∫ltimo login:', firestoreError);
        }

        showToast('üëã ¬°Bienvenido de nuevo!', true);
        showMainApp(user);

      } catch (error) {
        console.error('‚ùå Error en login:', error);
        handleAuthError(error);
      } finally {
        setLoadingState('login', false);
      }
    }

    function handleAuthError(error) {
      const errorMessages = {
        'auth/email-already-in-use': '‚ùå Este email ya est√° registrado',
        'auth/invalid-email': '‚ùå El formato del email no es v√°lido',
        'auth/weak-password': '‚ùå La contrase√±a es demasiado d√©bil',
        'auth/user-not-found': '‚ùå No existe una cuenta con este email',
        'auth/wrong-password': '‚ùå Contrase√±a incorrecta',
        'auth/too-many-requests': '‚ùå Demasiados intentos. Intenta m√°s tarde',
        'auth/network-request-failed': '‚ùå Error de conexi√≥n a internet'
      };

      const message = errorMessages[error.code] || `‚ùå Error: ${error.message}`;
      showToast(message);
    }

    function setLoadingState(formType, loading) {
      const btn = $(`btn-${formType}`);
      const btnText = $(`btn-${formType}-text`);
      const btnLoading = $(`btn-${formType}-loading`);
      
      btn.disabled = loading;
      if (loading) {
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
      } else {
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }
    }

    // ===== APLICACI√ìN PRINCIPAL =====
    function showMainApp(user) {
      console.log('üöÄ Mostrando aplicaci√≥n principal');
      $('#login-screen').classList.add('hidden');
      $('#app-main').classList.remove('hidden');
      
      // Actualizar informaci√≥n del usuario
      $('#user-display').textContent = user.displayName || user.email;
      
      // Configurar eventos de la aplicaci√≥n
      setupAppEvents();
    }

    function setupAppEvents() {
      // Logout
      $('#btn-logout').addEventListener('click', async () => {
        try {
          await signOut(auth);
          showToast('üëã Sesi√≥n cerrada correctamente');
        } catch (error) {
          showToast('‚ùå Error al cerrar sesi√≥n');
        }
      });

      // Toggle tema
      $('#theme-toggle').addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        $('#theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
      });

      // Inicializar tema
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      $('#theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

      // Eventos de los launchers de secci√≥n
      document.querySelectorAll('.section-launcher').forEach(launcher => {
        launcher.addEventListener('click', () => {
          const panel = launcher.dataset.panel;
          showToast(`üìÇ Abriendo ${launcher.querySelector('span:last-child').textContent}...`);
          // Aqu√≠ ir√≠a la l√≥gica para abrir el panel espec√≠fico
        });
      });
    }

    // ===== INICIALIZACI√ìN =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üéØ Inicializando aplicaci√≥n...');
      
      // Configurar eventos de formularios
      $('#register-form').addEventListener('submit', handleRegistration);
      $('#login-form').addEventListener('submit', handleLogin);
      
      // Configurar tabs de login/registro
      $('#tab-register').addEventListener('click', showRegisterForm);
      $('#tab-login').addEventListener('click', showLoginForm);
      
      // Toggles de contrase√±a
      $('#toggle-password').addEventListener('click', function() {
        const passwordField = $('#user-password');
        const type = passwordField.type === 'password' ? 'text' : 'password';
        passwordField.type = type;
        this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
      });

      $('#toggle-login-password').addEventListener('click', function() {
        const passwordField = $('#login-password');
        const type = passwordField.type === 'password' ? 'text' : 'password';
        passwordField.type = type;
        this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
      });

      // Verificar si ya hay un usuario autenticado
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log('üë§ Usuario ya autenticado:', user.email);
          showMainApp(user);
        } else {
          console.log('üîê No hay usuario autenticado');
          $('#login-screen').classList.remove('hidden');
          $('#app-main').classList.add('hidden');
        }
      });

      console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
    });

  </script>
</body>
</html>