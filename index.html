<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>JustPersonal ¬∑ Panel Principal</title>
<style>
    :root {
        --bg: #f8fafc; --panel: #ffffff; --card: #ffffff; --muted: #64748b; --text: #0f172a;
        --line: #e2e8f0; --accent: #0ea5e9; --shadow: 0 4px 12px rgba(2,6,23,.08);
    }
    html[data-theme="dark"] {
        --bg: #0f172a; --panel: #1e293b; --card: #1e293b; --muted: #94a3b8; --text: #f1f5f9; --line: #334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%; scroll-behavior: smooth;}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:var(--text); transition: background .2s, color .2s;}
    h1,h2,h3{margin:0; line-height: 1.2;}
    header.top{padding:16px 24px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10; display:flex; justify-content:space-between; align-items:center;}
    main{max-width:1200px;margin:32px auto;padding:0 24px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow); transition: transform .2s, box-shadow .2s;}
    .card:hover{transform: translateY(-4px);}
    .card header{padding:20px 20px 0}
    .card .content{padding:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:10px 14px;color:var(--text);cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;background:var(--panel);transition:.15s}
    .btn:hover{background:var(--bg); border-color: var(--accent);}
    .btn.primary{border-color:var(--accent);color:var(--accent); background: transparent;}
    .btn.primary:hover{background:var(--accent); color: white;}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--muted)}
    .btn.ghost:hover{color:var(--text); background: var(--bg);}
    .grid{display:grid;gap:16px}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    label{font-size:13px;color:var(--muted); font-weight: 500;}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--bg);color:var(--text)}
    input:focus, select:focus, textarea:focus {outline: 2px solid var(--accent); border-color: transparent;}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line); border-radius: 12px; overflow: hidden;}
    th,td{padding:12px 16px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{background:var(--bg)}
    tr:last-child td {border-bottom: 0;}
    tr:nth-child(even) {background-color: var(--bg);}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom: 1px solid var(--line); margin-bottom: 24px;}
    .tab{padding:12px 16px;border-bottom: 2px solid transparent;background:transparent;color:var(--muted);cursor:pointer;user-select:none; font-weight: 600; margin-bottom: -1px;}
    .tab:hover{color: var(--text);}
    .tab[aria-selected="true"]{color:var(--accent); border-bottom-color: var(--accent);}
    .hidden{display:none !important}
    .dashboard-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px;}
    .section-launcher {display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 24px; cursor: pointer; gap: 12px;}
    .section-launcher span:first-child {font-size: 48px;}
    .section-launcher span:last-child {font-size: 18px; font-weight: 600;}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .kpi .box{background:var(--bg);border:1px solid var(--line);border-radius:12px;padding:16px; position: relative; padding-left: 60px;}
    .kpi .icon {position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 28px; }
    .kpi .title{font-size:14px;color:var(--muted)}
    .kpi .value{font-weight:700;font-size:24px;margin-top:4px}
    .section-panel{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%) scale(0.95); opacity: 0; width:90vw;height:90vh;max-width:1200px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;z-index:100;display:flex;flex-direction:column; pointer-events: none; transition: transform .3s, opacity .3s;}
    .section-panel.open{transform:translate(-50%, -50%) scale(1); opacity: 1; pointer-events: all;}
    .section-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--line);background:var(--bg)}
    .section-title{font-weight:700;font-size:18px}
    .section-body{flex:1;overflow:auto;padding:24px}
    .chat-launcher{position:fixed;right:24px;bottom:24px;z-index:70}
    .chat-bubble{position:fixed;right:24px;bottom:88px;width:380px;max-width:95vw;height:68vh;display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;z-index:70; transform: translateY(12px) scale(0.95); opacity: 0; transition: .3s; pointer-events: none;}
    .chat-bubble.open{transform: translateY(0) scale(1); opacity: 1; pointer-events: all;}
    .msg{max-width:84%;padding:10px 14px;border-radius:14px;border:1px solid var(--line);background:var(--panel); line-height: 1.5; word-wrap: break-word;}
    .msg.me{align-self:flex-end;background:#dbeafe; color: #1e40af;}
    html[data-theme="dark"] .msg.me{background: #3b82f6; color: white;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99;opacity:0; transition: opacity .3s; pointer-events: none;}
    .overlay.open{opacity:1; pointer-events: all;}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;z-index:110;opacity:0;transform:scale(0.95);transition:.3s;pointer-events:none;}
    .modal.open{opacity:1;transform:scale(1);pointer-events:all;}
    .modal .box{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow-lg);width:min(600px,95vw);max-height:80vh;display:flex;flex-direction:column;}
    .modal .box header{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:600;display:flex;justify-content:space-between;align-items:center;}
    .modal .box .content{padding:16px;overflow:auto;line-height:1.6;}
    .modal .box .content h3 {margin: 16px 0 8px 0;}
    .modal .box .content pre {white-space:pre-wrap; font-family:inherit; background: var(--bg); padding: 12px; border-radius: 8px;}
</style>
</head>
<body>
  <header class="top"><h1>JustPersonal ¬∑ Panel Principal</h1><div class="row"><button class="btn ghost" id="theme-toggle" title="Cambiar tema">üåô</button></div></header>
  
  <main>
    <div class="dashboard-grid">
      <div class="card section-launcher" data-panel="panel-finanzas"><span>üí∞</span><span>Finanzas</span></div>
      <div class="card section-launcher" data-panel="panel-salud"><span>üè•</span><span>Salud</span></div>
      <div class="card section-launcher" data-panel="panel-entretenimiento"><span>üéÆ</span><span>Entretenimiento</span></div>
      <div class="card section-launcher" data-panel="panel-deportes"><span>‚öΩ</span><span>Deportes</span></div>
      <div class="card section-launcher" data-panel="panel-cocina"><span>üç≥</span><span>Cocina</span></div>
      <div class="card section-launcher" data-panel="panel-redes"><span>üì±</span><span>Redes Sociales</span></div>
    </div>
  </main>

  <div class="overlay" id="panel-overlay"></div>
  <div class="modal" id="modal"><div class="box"><header><span id="modal-title">Detalle</span><button class="btn ghost" id="modal-close">‚úñ</button></header><div class="content" id="modal-content"></div></div></div>
  
  <div class="section-panel" id="panel-finanzas"><div class="section-header"><div class="section-title">Finanzas</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body"><div aria-label="Gesti√≥n de Finanzas" class="tabs" role="tablist"><button aria-selected="true" class="tab" id="tab-resumen" role="tab">Resumen</button><button class="tab" id="tab-propiedades" role="tab">Propiedades</button><button class="tab" id="tab-alquileres" role="tab">Alquileres</button><button class="tab" id="tab-ingresos" role="tab">Otros Ingresos</button><button class="tab" id="tab-gastos" role="tab">Gastos</button><button class="tab" id="tab-servicios" role="tab">Servicios</button></div><div id="panel-resumen" role="tabpanel"><div class="row" style="align-items:end;gap:16px; margin-bottom: 24px;"><input id="res-mes" type="month"/> <button class="btn" id="btn-refrescar-resumen">Refrescar</button> </div><h3 style="margin-bottom: 12px;">Resumen del Mes</h3><div class="kpi"><div class="box"><span class="icon">üì•</span><div class="title">Ingresos Mes</div><div class="value" id="kpi-ing-mes">$0</div></div><div class="box"><span class="icon">üè†</span><div class="title">Alquiler Mes</div><div class="value" id="kpi-renta-mes">$0</div></div><div class="box"><span class="icon">üì§</span><div class="title">Gastos Mes</div><div class="value" id="kpi-gas-mes">$0</div></div><div class="box"><span class="icon">üí∞</span><div class="title">Saldo Mes</div><div class="value" id="kpi-saldo-mes">$0</div></div></div><h3 style="margin: 24px 0 12px 0;">Acumulado Total</h3><div class="kpi"><div class="box"><span class="icon">üì•</span><div class="title">Ingresos Acum</div><div class="value" id="kpi-ing-acum">$0</div></div><div class="box"><span class="icon">üè†</span><div class="title">Alquiler Acum</div><div class="value" id="kpi-renta-acum">$0</div></div><div class="box"><span class="icon">üì§</span><div class="title">Gastos Acum</div><div class="value" id="kpi-gas-acum">$0</div></div><div class="box"><span class="icon">üí∞</span><div class="title">Saldo Acum</div><div class="value" id="kpi-saldo-acum">$0</div></div></div></div><div class="hidden" id="panel-propiedades" role="tabpanel"><div class="card"><header><h2>A√±adir/Editar Propiedad</h2></header><div class="content"><form id="form-propiedad" class="grid two"><input id="prop-id" type="hidden"/><div class="col"><label for="prop-nombre">Nombre</label><input id="prop-nombre" required=""/></div><div class="col"><label for="prop-ciudad">Ciudad</label><input id="prop-ciudad" required=""/></div><div class="col"><label for="prop-arrendatario">Arrendatario</label><input id="prop-arrendatario" required=""/></div><div class="col"><label for="prop-alquiler">Alquiler ($)</label><input id="prop-alquiler" type="number"/></div><div class="row" style="grid-column: 1 / -1;"><button class="btn primary" type="submit">Guardar</button><button class="btn ghost" id="btn-cancelar-propiedad" type="reset">Limpiar</button></div></form></div></div><div class="card" style="margin-top:24px;"><header><h2>Propiedades Guardadas</h2></header><div class="content"><table id="tabla-propiedades"><thead><tr><th>Propiedad</th><th>Ciudad</th><th>Arrendatario</th><th>Alquiler</th><th>Acciones</th></tr></thead><tbody></tbody></table></div></div></div><div class="hidden" id="panel-alquileres" role="tabpanel">...</div><div class="hidden" id="panel-ingresos" role="tabpanel">...</div><div class="hidden" id="panel-gastos" role="tabpanel">...</div><div class="hidden" id="panel-servicios" role="tabpanel">...</div></div></div>
  <div class="section-panel" id="panel-salud"><div class="section-header"><div class="section-title">Salud</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body">...</div></div>
  <div class="section-panel" id="panel-entretenimiento"><div class="section-header"><div class="section-title">Entretenimiento</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body">...</div></div>
  <div class="section-panel" id="panel-deportes"><div class="section-header"><div class="section-title">Deportes</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body">...</div></div>
  <div class="section-panel" id="panel-cocina"><div class="section-header"><div class="section-title">Cocina</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body">...</div></div>
  <div class="section-panel" id="panel-redes"><div class="section-header"><div class="section-title">Redes Sociales</div><div class="section-actions"><button class="btn ghost btn-close-section" title="Cerrar">‚úñ</button></div></div><div class="section-body">...</div></div>

  <div class="chat-launcher"><button class="btn primary" id="open-chat" title="Asistente">üí¨</button></div>
  <aside class="chat-bubble" id="chat-panel"><div class="chat-header"><div class="chat-title">Asistente Virtual</div><div class="chat-actions"><button class="btn ghost" id="btn-clear-chat" title="Borrar">üóëÔ∏è</button><button class="btn ghost" id="btn-close-chat" title="Cerrar">‚úñ</button></div></div><div class="chipbar"><span class="chip" data-chip="resumen">üìä Resumen</span><span class="chip" data-chip="propiedades">üè† Propiedades</span></div><div class="chat-body" id="chat-body"></div><div class="chat-footer"><input id="chat-input" placeholder="Pregunta algo..."/><button class="btn primary" id="chat-send">Enviar</button></div></aside>
  <div class="toast" id="toast"></div>

  <script type="module">
    // ===== CONFIGURACI√ìN E IMPORTACI√ìN DE FIREBASE =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9vOVrtGrdVYU9FgUCtpZWOTwpmO5t2n4",
      authDomain: "propiedades-7f7fe.firebaseapp.com",
      projectId: "propiedades-7f7fe",
      storageBucket: "propiedades-7f7fe.appspot.com",
      messagingSenderId: "429219311761",
      appId: "1:429219311761:web:4d45c7c5e53cc7c5394f30"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    let userDocRef;

    // ===== UTILIDADES Y ESTADO GLOBAL =====
    const $=(s,r=document)=>r.querySelector(s); 
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const toast=(m)=>{const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000)};
    const fmt=(n)=> new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(Number(n||0));
    const toYM=d=>(d||'').slice(0,7); 

    let state={
        propiedades: [], ingresos: [], gastos: [], servicios: [], 
        chat: [], alquileres: [], links: [], recetas: []
    };
    
    // ===== SINCRONIZACI√ìN CON FIREBASE =====
    let authReadyPromiseResolver;
    const authReadyPromise = new Promise(resolve => { authReadyPromiseResolver = resolve; });

    async function persist() {
        await authReadyPromise;
        if (!userDocRef) return;
        try { await setDoc(userDocRef, state); } catch (e) { console.error("Error al guardar:", e); toast("Error de conexi√≥n."); }
    }

    onAuthStateChanged(auth, user => {
        if (user) {
            userDocRef = doc(db, "users", user.uid);
            authReadyPromiseResolver();
            onSnapshot(userDocRef, (doc) => {
                const data = doc.exists() ? doc.data() : {};
                Object.keys(state).forEach(key => { state[key] = data[key] || []; });
                renderAll();
                loadChatHistory();
            });
        } else {
            signInAnonymously(auth).catch(e => console.error("Error de auth:", e));
        }
    });
    
    // ===== FUNCI√ìN DE CARGA DE DATOS (PARA CONSOLA) =====
    window.loadData = async function(dataToLoad) {
        await authReadyPromise;
        if (!dataToLoad) { return alert("No hay datos para cargar."); }
        
        Object.keys(dataToLoad).forEach(key => {
            if (state.hasOwnProperty(key) && Array.isArray(dataToLoad[key])) {
                dataToLoad[key].forEach(newItem => {
                    const uniqueId = newItem.id || newItem.nombre;
                    if (!state[key].some(existing => (existing.id || existing.nombre) === uniqueId)) {
                        state[key].push(newItem);
                    }
                });
            }
        });

        await persist();
        alert(`Carga completada. Los datos deber√≠an aparecer ahora.`);
    }

    // ===== UI (PANELES, MODALES, TABS, ETC.) =====
    const modal = $('#modal'); const overlay = $('#panel-overlay');
    function openSection(id) { overlay.classList.add('open'); $(`#${id}`)?.classList.add('open'); }
    function closeSection(id) { $(`#${id}`)?.classList.remove('open'); if (!$$('.section-panel.open').length) overlay.classList.remove('open');}
    function openModal(title, content) { $('#modal-title').textContent = title; $('#modal-content').innerHTML = content; overlay.classList.add('open'); modal.classList.add('open'); }
    function closeModal() { modal.classList.remove('open'); if (!$$('.section-panel.open').length) overlay.classList.remove('open'); }
    function closeAll() { $$('.section-panel.open').forEach(p => p.classList.remove('open')); closeModal(); }
    
    // ===== RENDERIZADO =====
    function renderAll() { renderPropiedades(); renderResumen(); /* ... y otras ... */ }
    function renderPropiedades(){ const tb=$('#tabla-propiedades tbody'); tb.innerHTML=''; state.propiedades.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.nombre}</td><td>${p.ciudad}</td><td>${p.arrendatario}</td><td>${fmt(p.alquiler||0)}</td><td class="row"><button class="btn ghost" data-type="prop-edit" data-i="${i}">Editar</button><button class="btn ghost" data-type="prop-dup" data-i="${i}">Duplicar</button><button class="btn ghost" data-type="prop-del" data-i="${i}">Eliminar</button></td>`; tb.append(tr); }); }
    function renderResumen(){ const ym=$('#res-mes')?.value||toYM(new Date().toISOString()); if($('#res-mes')) $('#res-mes').value=ym; const sum = (list, filter, key) => list.filter(filter).reduce((s, r) => s + Number(r[key] || 0), 0); const ingM=sum(state.ingresos, r=>toYM(r.fecha)===ym, 'monto'), gasM=sum(state.gastos, r=>toYM(r.fecha)===ym, 'monto'), alqM=sum(state.alquileres, a=>a.mes===ym, 'monto'); const ingA=sum(state.ingresos, ()=>true, 'monto'), gasA=sum(state.gastos, ()=>true, 'monto'), alqA=sum(state.alquileres, ()=>true, 'monto'); const set=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=fmt(v);}; set('kpi-ing-mes',ingM); set('kpi-renta-mes',alqM); set('kpi-gas-mes',gasM); set('kpi-saldo-mes', (ingM+alqM)-gasM); set('kpi-ing-acum',ingA); set('kpi-renta-acum',alqA); set('kpi-gas-acum',gasA); set('kpi-saldo-acum', (ingA+alqA)-gasA); }

    // ===== FORMULARIOS Y ACCIONES =====
    let editingPropIndex=null;
    function startEditProp(index) { /* ... (c√≥digo anterior) ... */ }
    $('#form-propiedad').addEventListener('submit', async (e)=>{ e.preventDefault(); const id=$('#prop-id').value||crypto.randomUUID(); const data={id, nombre:$('#prop-nombre').value, ciudad:$('#prop-ciudad').value, arrendatario:$('#prop-arrendatario').value, alquiler:$('#prop-alquiler').value}; if(editingPropIndex!==null){state.propiedades[editingPropIndex]=data;}else{state.propiedades.push(data);} await persist(); editingPropIndex=null; e.target.reset();});
    
    // ===== ASISTENTE VIRTUAL =====
    const chat={ panel:$('#chat-panel'), body:$('#chat-body'), input:$('#chat-input') };
    async function pushMsg(html, me=false){ /* ... (c√≥digo anterior) ... */ }
    async function processAssistantQuery(query) { /* ... (c√≥digo anterior) ... */ }
    function loadChatHistory(clearAndGreet = false) { /* ... (c√≥digo anterior) ... */ }
    
    // ===== INICIALIZACI√ìN =====
    document.addEventListener('DOMContentLoaded', () => {
        // Atar todos los event listeners de la UI
        $('#modal-close').addEventListener('click', closeModal);
        $('#panel-overlay').addEventListener('click', closeAll);
        $$('.section-launcher').forEach(launcher => launcher.addEventListener('click', () => openSection(launcher.dataset.panel)));
        $$('.btn-close-section').forEach(btn => btn.addEventListener('click', () => closeSection(btn.closest('.section-panel').id)));
        $('#theme-toggle').addEventListener('click', () => { 
            const doc = document.documentElement;
            const newTheme = doc.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; 
            localStorage.setItem('theme', newTheme); 
            doc.setAttribute('data-theme', newTheme); 
            $('#theme-toggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        });

        const tabsContainer = $('#panel-finanzas');
        if (!tabsContainer) return;
        const tabs=$$('.tab', tabsContainer); 
        const panels=$$('div[id^="panel-"]', tabsContainer);
        window.selectFinanceTab=(id)=>{ tabs.forEach(t=>t.setAttribute('aria-selected',t.id === 'tab-'+id)); panels.forEach(p=>p.classList.toggle('hidden', p.id !== 'panel-'+id)); }; 
        tabs.forEach(t=> t.addEventListener('click',()=> window.selectFinanceTab(t.id.replace('tab-',''))));
        
        // Dark Mode Init
        const doc = document.documentElement;
        const storedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = storedTheme || (prefersDark ? 'dark' : 'light');
        doc.setAttribute('data-theme', theme);
        $('#theme-toggle').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        // Chat listeners
        const toggleChat = (force) => $('#chat-panel').classList.toggle('open', force);
        $('#open-chat').addEventListener('click', () => toggleChat());
        $('#btn-close-chat').addEventListener('click', () => toggleChat(false));
    });
  </script>
</body>
</html>