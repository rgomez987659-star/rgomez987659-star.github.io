<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>JustPersonal ¬∑ Panel Principal</title>
<style>
    :root {
        --bg: #f8fafc; --panel: #ffffff; --card: #ffffff; --muted: #64748b; --text: #0f172a;
        --line: #e2e8f0; --accent: #0ea5e9; --shadow: 0 4px 12px rgba(2,6,23,.08);
    }
    html[data-theme="dark"] {
        --bg: #0f172a; --panel: #1e293b; --card: #1e293b; --muted: #94a3b8; --text: #f1f5f9; --line: #334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%; scroll-behavior: smooth;}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;color:var(--text); transition: background .2s, color .2s;}
    h1,h2,h3{margin:0; line-height: 1.2;}
    header.top{padding:16px 24px;border-bottom:1px solid var(--line);background:var(--panel);position:sticky;top:0;z-index:10; display:flex; justify-content:space-between; align-items:center;}
    main{max-width:1200px;margin:32px auto;padding:0 24px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow); transition: transform .2s, box-shadow .2s;}
    .card:hover{transform: translateY(-4px);}
    .card header{padding:20px 20px 0}
    .card .content{padding:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;}
    .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:10px 14px;color:var(--text);cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600;background:var(--panel);transition:.15s}
    .btn:hover{background:var(--bg); border-color: var(--accent);}
    .btn.primary{border-color:var(--accent);color:var(--accent); background: transparent;}
    .btn.primary:hover{background:var(--accent); color: white;}
    .btn.ghost{background:transparent;border-color:transparent;color:var(--muted)}
    .btn.ghost:hover{color:var(--text); background: var(--bg);}
    .grid{display:grid;gap:16px}
    .grid.two{grid-template-columns:repeat(auto-fit,minmax(250px,1fr));}
    .grid.three{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));}
    .col{display: flex; flex-direction: column; gap: 4px;}
    label{font-size:13px;color:var(--muted); font-weight: 500;}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--bg);color:var(--text)}
    input:focus, select:focus, textarea:focus {outline: 2px solid var(--accent); border-color: transparent;}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line); border-radius: 12px; overflow: hidden;}
    th,td{padding:12px 16px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{background:var(--bg)}
    tr:last-child td {border-bottom: 0;}
    tr:nth-child(even) {background-color: var(--bg);}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom: 1px solid var(--line); margin-bottom: 24px;}
    .tab{padding:12px 16px;border-bottom: 2px solid transparent;background:transparent;color:var(--muted);cursor:pointer;user-select:none; font-weight: 600; margin-bottom: -1px;}
    .tab:hover{color: var(--text);}
    .tab[aria-selected="true"]{color:var(--accent); border-bottom-color: var(--accent);}
    .hidden{display:none !important}
    .dashboard-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px;}
    .section-launcher {display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 24px; cursor: pointer; gap: 12px;}
    .section-launcher span:first-child {font-size: 48px;}
    .section-launcher span:last-child {font-size: 18px; font-weight: 600;}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px}
    .kpi .box{background:var(--bg);border:1px solid var(--line);border-radius:12px;padding:16px; position: relative; padding-left: 60px;}
    .kpi .icon {position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 28px; }
    .kpi .title{font-size:14px;color:var(--muted)}
    .kpi .value{font-weight:700;font-size:24px;margin-top:4px}
    .section-panel{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%) scale(0.95); opacity: 0; width:90vw;height:90vh;max-width:1200px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;z-index:100;display:flex;flex-direction:column; pointer-events: none; transition: transform .3s, opacity .3s;}
    .section-panel.open{transform:translate(-50%, -50%) scale(1); opacity: 1; pointer-events: all;}
    .section-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--line);background:var(--bg)}
    .section-title{font-weight:700;font-size:18px}
    .section-body{flex:1;overflow:auto;padding:24px}
    .chat-launcher{position:fixed;right:24px;bottom:24px;z-index:70}
    .chat-bubble{position:fixed;right:24px;bottom:88px;width:380px;max-width:95vw;height:68vh;display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;z-index:70; transform: translateY(12px) scale(0.95); opacity: 0; transition: .3s; pointer-events: none;}
    .chat-bubble.open{transform: translateY(0) scale(1); opacity: 1; pointer-events: all;}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--line);background:var(--bg)}
    .chat-title{font-weight:600}
    .chat-body{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .chat-footer{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--line);background:var(--bg)}
    .chat-footer input{flex:1}
    .msg{max-width:84%;padding:10px 14px;border-radius:14px;border:1px solid var(--line);background:var(--panel); line-height: 1.5; word-wrap: break-word;}
    .msg.me{align-self:flex-end;background:#dbeafe; color: #1e40af;}
    html[data-theme="dark"] .msg.me{background: #3b82f6; color: white;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:99;opacity:0; transition: opacity .3s; pointer-events: none;}
    .overlay.open{opacity:1; pointer-events: all;}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;z-index:110;opacity:0;transform:scale(0.95);transition:.3s;pointer-events:none;}
    .modal.open{opacity:1;transform:scale(1);pointer-events:all;}
    .modal .box{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow-lg);width:min(600px,95vw);max-height:80vh;display:flex;flex-direction:column;}
    .modal .box header{padding:12px 16px;border-bottom:1px solid var(--line);font-weight:600;display:flex;justify-content:space-between;align-items:center;}
    .modal .box .content{padding:16px;overflow:auto;line-height:1.6;}
    .sync-status {position: fixed; top: 80px; right: 24px; padding: 8px 12px; border-radius: 8px; font-size: 12px; z-index: 50;}
    .sync-status.connected {background: #10b981; color: white;}
    .sync-status.disconnected {background: #ef4444; color: white;}
    .web-link {color: var(--accent); text-decoration: none; font-size: 12px;}
    .web-link:hover {text-decoration: underline;}
    .login-screen {position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000;flex-direction:column;gap:24px;padding:24px;}
    .user-info {display:flex;align-items:center;gap:8px;font-size:14px;}
    .password-field {position: relative;}
    .password-toggle {position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--muted); cursor: pointer;}
    .loading {opacity: 0.6; pointer-events: none;}
</style>
</head>
<body>
  <!-- Pantalla de Login/Registro -->
  <div class="login-screen" id="login-screen">
    <div class="card" style="max-width:400px;width:100%;">
      <header style="text-align:center;padding:24px 20px 0;">
        <h1>JustPersonal</h1>
        <p style="color:var(--muted);margin:8px 0 0;">Gesti√≥n de Propiedades Inteligente</p>
      </header>
      <div class="content">
        <form id="login-form" class="grid">
          <div class="col">
            <label for="user-email">Correo Electr√≥nico</label>
            <input type="email" id="user-email" required placeholder="tu@email.com"/>
          </div>
          <div class="col">
            <label for="user-name">Nombre Completo</label>
            <input type="text" id="user-name" required placeholder="Tu nombre completo"/>
          </div>
          <div class="col password-field">
            <label for="user-password">Contrase√±a</label>
            <input type="password" id="user-password" required placeholder="Crea una contrase√±a segura" minlength="6"/>
            <button type="button" class="password-toggle" id="toggle-password">üëÅÔ∏è</button>
          </div>
          <div class="row">
            <button type="submit" class="btn primary" style="flex:1;" id="btn-register">
              <span id="btn-text">Crear Cuenta y Acceder</span>
              <span id="btn-loading" class="hidden">‚è≥ Creando cuenta...</span>
            </button>
          </div>
        </form>
        <div style="text-align:center;margin-top:16px;">
          <p style="color:var(--muted);font-size:12px;">Al registrarte aceptas nuestros t√©rminos y condiciones</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Aplicaci√≥n Principal (oculta inicialmente) -->
  <div id="app-main" class="hidden">
    <!-- El contenido completo de la aplicaci√≥n principal va aqu√≠ -->
    <p style="text-align:center;padding:40px;">Aplicaci√≥n cargada correctamente</p>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // ===== CONFIGURACI√ìN E IMPORTACI√ìN DE FIREBASE =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged, 
      setPersistence, 
      browserSessionPersistence,
      updateProfile 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      onSnapshot, 
      setDoc 
    } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9vOVrtGrdVYU9FgUCtpZWOTwpmO5t2n4",
      authDomain: "propiedades-7f7fe.firebaseapp.com",
      projectId: "propiedades-7f7fe",
      storageBucket: "propiedades-7f7fe.appspot.com",
      messagingSenderId: "429219311761",
      appId: "1:429219311761:web:4d45c7c5e53cc7c5394f30"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== ESTADO GLOBAL =====
    let state = {
      propiedades: [], 
      chat: [], 
      alquileres: [], 
      ingresos: [], 
      gastos: [], 
      servicios: []
    };

    // ===== FUNCIONES DE UTILIDAD =====
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const toast = (m) => {
      const t = $('#toast');
      t.textContent = m;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    };

    // ===== SISTEMA DE REGISTRO =====
    
    // Configurar persistencia de sesi√≥n
    setPersistence(auth, browserSessionPersistence)
      .then(() => {
        console.log("Persistencia configurada para sesi√≥n del navegador");
      })
      .catch((error) => {
        console.error("Error configurando persistencia:", error);
      });

    function showLoginScreen() {
      console.log("üîê Mostrando pantalla de login");
      $('#login-screen').classList.remove('hidden');
      $('#app-main').classList.add('hidden');
      resetLoginForm();
    }

    function showMainApp(user) {
      console.log("üöÄ Mostrando aplicaci√≥n principal para:", user.email);
      $('#login-screen').classList.add('hidden');
      $('#app-main').classList.remove('hidden');
      
      // Aqu√≠ ir√≠a la inicializaci√≥n completa de la aplicaci√≥n
      initializeUserApp(user);
    }

    function resetLoginForm() {
      $('#login-form').reset();
      $('#btn-register').disabled = false;
      $('#btn-text').classList.remove('hidden');
      $('#btn-loading').classList.add('hidden');
      $('#btn-register').classList.remove('loading');
    }

    function setLoadingState(loading) {
      const btn = $('#btn-register');
      const btnText = $('#btn-text');
      const btnLoading = $('#btn-loading');
      
      if (loading) {
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        btn.classList.add('loading');
      } else {
        btn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
        btn.classList.remove('loading');
      }
    }

    async function handleUserRegistration() {
      const email = $('#user-email').value.trim();
      const name = $('#user-name').value.trim();
      const password = $('#user-password').value;

      console.log("üìù Intentando registro con:", { email, name, password: '***' });

      // Validaciones
      if (!email || !name || !password) {
        toast('‚ùå Por favor completa todos los campos');
        return;
      }

      if (password.length < 6) {
        toast('‚ùå La contrase√±a debe tener al menos 6 caracteres');
        return;
      }

      if (!validateEmail(email)) {
        toast('‚ùå Por favor ingresa un email v√°lido');
        return;
      }

      setLoadingState(true);

      try {
        console.log("üî• Creando usuario en Firebase...");
        
        // 1. Crear usuario con email y contrase√±a
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log("‚úÖ Usuario creado:", user.uid);

        // 2. Actualizar perfil con el nombre
        await updateProfile(user, {
          displayName: name
        });
        
        console.log("‚úÖ Perfil actualizado");

        // 3. Crear documento de perfil en Firestore
        await setDoc(doc(db, "userProfiles", user.uid), {
          email: email,
          name: name,
          createdAt: new Date().toISOString(),
          lastLogin: new Date().toISOString()
        });

        console.log("‚úÖ Perfil guardado en Firestore");

        // 4. Inicializar datos del usuario
        const userDocRef = doc(db, "users", user.uid);
        await setDoc(userDocRef, {
          ...state,
          userInfo: {
            email: email,
            name: name,
            createdAt: new Date().toISOString()
          }
        });

        console.log("‚úÖ Datos de usuario inicializados");

        // 5. Mostrar aplicaci√≥n principal
        toast(`üéâ ¬°Bienvenido ${name}!`);
        showMainApp(user);

      } catch (error) {
        console.error("‚ùå Error en registro:", error);
        handleRegistrationError(error);
      } finally {
        setLoadingState(false);
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function handleRegistrationError(error) {
      console.error("C√≥digo de error:", error.code);
      
      switch (error.code) {
        case 'auth/email-already-in-use':
          toast('‚ùå Este email ya est√° registrado. Por favor usa otro email.');
          break;
        case 'auth/invalid-email':
          toast('‚ùå El formato del email no es v√°lido.');
          break;
        case 'auth/weak-password':
          toast('‚ùå La contrase√±a es demasiado d√©bil. Usa al menos 6 caracteres.');
          break;
        case 'auth/network-request-failed':
          toast('‚ùå Error de conexi√≥n. Verifica tu internet.');
          break;
        case 'auth/too-many-requests':
          toast('‚ùå Demasiados intentos. Espera unos minutos.');
          break;
        default:
          toast('‚ùå Error al crear la cuenta: ' + error.message);
      }
    }

    function initializeUserApp(user) {
      console.log("üîÑ Inicializando aplicaci√≥n para:", user.uid);
      
      // Aqu√≠ ir√≠a toda la l√≥gica de inicializaci√≥n de la aplicaci√≥n
      // Por ahora solo mostramos un mensaje
      $('#app-main').innerHTML = `
        <header class="top">
          <h1>JustPersonal ¬∑ Panel Principal</h1>
          <div class="row">
            <div class="user-info">
              <span>${user.displayName || user.email}</span>
              <button class="btn ghost" id="btn-logout" title="Cerrar sesi√≥n">üë§</button>
            </div>
            <button class="btn ghost" id="theme-toggle" title="Cambiar tema">üåô</button>
          </div>
        </header>
        <main>
          <div style="text-align:center;padding:100px;">
            <h2>¬°Bienvenido ${user.displayName}!</h2>
            <p>Tu aplicaci√≥n se ha cargado correctamente.</p>
            <p>Email: ${user.email}</p>
            <p>UID: ${user.uid}</p>
            <button class="btn primary" id="btn-test-logout">Cerrar Sesi√≥n de Prueba</button>
          </div>
        </main>
      `;

      // Configurar eventos de la aplicaci√≥n
      $('#btn-test-logout').addEventListener('click', () => {
        signOut(auth).then(() => {
          toast('Sesi√≥n cerrada correctamente');
        });
      });

      $('#btn-logout').addEventListener('click', () => {
        signOut(auth).then(() => {
          toast('Sesi√≥n cerrada correctamente');
        });
      });

      // Configurar tema
      $('#theme-toggle').addEventListener('click', () => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        $('#theme-toggle').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
      });

      // Inicializar tema
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      $('#theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    // ===== INICIALIZACI√ìN DE LA APLICACI√ìN =====
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("üöÄ Inicializando aplicaci√≥n JustPersonal...");

      // Configurar evento de registro
      $('#login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log("üìù Formulario de registro enviado");
        await handleUserRegistration();
      });

      // Toggle para mostrar/ocultar contrase√±a
      $('#toggle-password').addEventListener('click', () => {
        const passwordField = $('#user-password');
        const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordField.setAttribute('type', type);
        $('#toggle-password').textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
      });

      // Verificar si ya hay un usuario autenticado
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("üë§ Usuario ya autenticado:", user.email);
          showMainApp(user);
        } else {
          console.log("üîê No hay usuario autenticado, mostrando login");
          showLoginScreen();
        }
      });

      console.log("‚úÖ Aplicaci√≥n inicializada correctamente");
    });

  </script>
</body>
</html>